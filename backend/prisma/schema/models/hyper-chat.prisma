/**
 * ハイパーチャット注文/決済情報
 * PaymentIntent 作成時に pending で作成され、Webhook で status 更新
 */
model HyperChatOrder {
  id                    Int      @id @default(autoincrement())
  stripePaymentIntentId String   @unique // pi_xxx
  userId                Int
  channelId             String
  group                 String
  gender                String
  tier                  String // "free", "lite", "standard", "premium", "special"
  amount                Int // 金額（円）
  message               String
  isAnonymous           Boolean  @default(false)
  status                String   @default("pending") // pending, completed, failed
  createdAt             DateTime @default(now()) @db.Timestamptz(3)
  updatedAt             DateTime @updatedAt @db.Timestamptz(3)

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  hyperChat HyperChat?

  @@index([userId, createdAt])
  @@index([status, createdAt])
}

/**
 * ハイパーチャット（確定済みのみ）
 * User -> VTuber への有料コメント
 * orderId: 購入時は設定、チケット利用時は null
 * ticketId: チケット利用時は設定、購入時は null
 */
model HyperChat {
  id        Int      @id @default(autoincrement())
  orderId   Int?     @unique // nullable - 購入時のみ設定、チケット利用時は null
  ticketId  Int?     @unique // nullable - チケット利用時のみ設定、購入時は null
  userId    Int
  channelId String
  group     String
  gender    String
  tier      String // "free", "lite", "standard", "premium", "special"
  amount    Int // 金額（円）- free tier は 0
  message     String
  isAnonymous Boolean  @default(false)
  likeCount   Int      @default(0)
  createdAt DateTime @default(now()) @db.Timestamptz(3)

  order  HyperChatOrder?  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  ticket HyperChatTicket? @relation(fields: [ticketId], references: [id])
  user         User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  likes        HyperChatLike[]
  contribution HyperTrainContribution?

  @@index([channelId, createdAt])
  @@index([userId, createdAt])
}

/**
 * ハイパーチャットへのいいね
 */
model HyperChatLike {
  id          Int      @id @default(autoincrement())
  hyperChatId Int
  userId      Int
  createdAt   DateTime @default(now()) @db.Timestamptz(3)

  hyperChat HyperChat @relation(fields: [hyperChatId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([hyperChatId, userId])
  @@index([userId])
}
